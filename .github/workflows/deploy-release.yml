name: Deploy App Frontend

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to deploy'
        required: true
        default: 'latest'

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '20'
  S3_BUCKET: 'titan-app-static-site-8fbf908b'
  CLOUDFRONT_DISTRIBUTION_ID: 'EX6Y4ZPOCGMW6'

jobs:
  # Build and test the frontend application
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'package-lock.json'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint

    - name: Build static site
      run: npm run build:static

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build-${{ github.ref_name || github.sha }}
        path: out/
        retention-days: 7

  # Deploy to S3 and CloudFront
  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-build-${{ github.ref_name || github.sha }}
        path: out/

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_GITHUB_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy to S3
      run: |
        echo "ğŸš€ Deploying website to S3..."
        
        # Simple deployment that matches our manual process
        aws s3 sync out/ s3://${{ env.S3_BUCKET }}/ --delete

        echo "âœ… S3 deployment completed"

    - name: Invalidate CloudFront
      run: |
        echo "ğŸ”„ Invalidating CloudFront cache..."
        aws cloudfront create-invalidation \
          --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
          --paths "/*"
        echo "âœ… CloudFront cache invalidation initiated"

    - name: Get deployment URL
      run: |
        URL=$(aws cloudfront get-distribution --id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} --query 'Distribution.DomainName' --output text)
        echo "ğŸŒ App Frontend URL: https://$URL"
        echo "ğŸŒ App Domain: https://app.titanforecast.com"
        echo "ğŸ“¦ S3 Bucket: ${{ env.S3_BUCKET }}"
        if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "ğŸš€ Deployed from main branch (commit: ${{ github.sha }})"
        else
          echo "ğŸ·ï¸  Release Tag: ${{ github.ref_name }}"
        fi
        echo "::notice::App frontend deployed successfully! URL: https://$URL"

  # Security scan
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        exit-code: '0'

    - name: Security scan summary
      run: |
        echo "âœ… Security scan completed successfully"
        echo "ğŸ“Š Vulnerability scan results are shown above"
        if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "ğŸš€ Scanned main branch (commit: ${{ github.sha }})"
        else
          echo "ğŸ·ï¸  Release Tag: ${{ github.ref_name }}"
        fi
